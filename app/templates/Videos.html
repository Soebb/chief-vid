{% extends "BasePage.html" %} {% block content %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>

{% raw %}
<main id="app">
	<div class="input-group">
		<input v-model="query" class="form-control" list="datalist" placeholder="Suche ..." />
		<div class="input-group-append">
			<button @click="query = ''" class="btn btn-outline-secondary" type="button">X</button>
		</div>
		<datalist id="datalist">
			<option v-for="el in datalistOptions" v-bind:value="el" />
		</datalist>
	</div>

	<section v-for="category of categories" class="row py-4">
		<h3>{{ category }}</h3>
		<hr />
		<div class="row">
			<div v-for="vid of vidsForCategory(category)" class="col-md-4 col-lg-3 col-sm-12">
				<div class="border rounded p-4 h-100 shadow-sm">
					<h3 class="mb-4 font-weight-normal">{{ vid.name }}</h3>
					<p class="card-text">Datum: {{ getHumanDate(vid.date) }}</p>
					<p class="card-text">Größe: {{ getHumanSize(vid.size) }}</p>
					<p class="card-text">Länge: {{ vid.duration }}</p>
					<a v-bind:href="getVideoUrl(category, vid.file)">
						<button class="btn btn-lg btn-primary" type="button">Öffnen</button>
					</a>
				</div>
			</div>
		</div>
	</section>
</main>
{% endraw %}

<script>
	var app = new Vue({
		el: "#app",
		data: {
			files: {{ files|tojson }},
			selectedFiles: {{ files|tojson }},
			query: ""
		},
		methods: {
			getHumanSize(size) {
				if (size < 1024*1024*1) return "<1 MB";
				else return `${Math.floor(size / (1024 * 1024))} MB`;
			},
			getHumanDate(date) {
				return date;
			},
			getVideoUrl(category, vid) {
				return `/videos/${category}/${vid}`;
			},
			vidsForCategory(category) {
				return this.selectedFiles.filter(x => x.category == category)
				.sort((x,y) => {
					const xName = x.name.toUpperCase(); // ignore upper and lowercase
					const yName = y.name.toUpperCase(); // ignore upper and lowercase
					if (xName < yName) {
						return -1;
					}
					if (xName > yName) {
						return 1;
					}

					// names must be equal
					return 0;
				}
				);
			}
		},
		computed: {
			datalistOptions() {
				return [...new Set(this.files.flatMap(x => [x.name, x.category]))];
			},
			categories() {
				return [...new Set(this.selectedFiles.map(x => x.category))]
				.sort((x,y) => {
					const xName = x.toUpperCase(); // ignore upper and lowercase
					const yName = y.toUpperCase(); // ignore upper and lowercase
					if (xName < yName) {
						return -1;
					}
					if (xName > yName) {
						return 1;
					}

					// names must be equal
					return 0;
				}
				);
			}
		},
		watch: {
			query: function (newVal, oldVal) {
				const q = newVal.toLowerCase();
				this.selectedFiles = this.files.filter(x => x.file.toLowerCase().includes(q) || x.category.toLowerCase().includes(q));
			}
		}
	});
</script>

{% endblock content %}
